var W={exports:{}};(function(_,R){(function(l,m){_.exports=m()})(self,function(){return(()=>{var l={d:(e,t)=>{for(var r in t)l.o(t,r)&&!l.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},m={};l.r(m),l.d(m,{isServiceWorkerRequest:()=>A,serviceWorkerFetchListener:()=>x,asyncSleep:()=>b,ServiceWorkerError:()=>y,writeMessageAtomics:()=>k,writeMessageServiceWorker:()=>E,writeMessage:()=>P,makeChannel:()=>M,makeAtomicsChannel:()=>I,makeServiceWorkerChannel:()=>O,readMessage:()=>T,syncSleep:()=>N,uuidv4:()=>g});var w=function(e,t,r,n){return new(r||(r=Promise))(function(c,o){function i(s){try{a(n.next(s))}catch(f){o(f)}}function u(s){try{a(n.throw(s))}catch(f){o(f)}}function a(s){var f;s.done?c(s.value):(f=s.value,f instanceof r?f:new r(function(d){d(f)})).then(i,u)}a((n=n.apply(e,[])).next())})};const S="__SyncMessageServiceWorkerInput__",p="__sync-message-v2__";function A(e){return typeof e!="string"&&(e=e.request.url),e.includes(S)}function x(){const e={},t={};return r=>{const{url:n}=r.request;return!!A(n)&&(r.respondWith(function(){return w(this,void 0,void 0,function*(){function c(o){const i={message:o,version:p};return new Response(JSON.stringify(i),{status:200})}if(n.endsWith("/read")){const{messageId:o,timeout:i}=yield r.request.json();if(o in e){const u=e[o];return delete e[o],c(u)}return yield new Promise(u=>{t[o]=u,setTimeout(function(){delete t[o],u(new Response("",{status:408}))},i)})}if(n.endsWith("/write")){const{message:o,messageId:i}=yield r.request.json(),u=t[i];return u?(u(c(o)),delete t[i]):e[i]=o,c({early:!u})}if(n.endsWith("/version"))return new Response(p,{status:200})})}()),!0)}}function b(e){return new Promise(t=>setTimeout(t,e))}class y extends Error{constructor(t,r){super(`Received status ${r} from ${t}. Ensure the service worker is registered and active.`),this.url=t,this.status=r,this.type="ServiceWorkerError",Object.setPrototypeOf(this,y.prototype)}}function k(e,t){const r=new TextEncoder().encode(JSON.stringify(t)),{data:n,meta:c}=e;if(r.length>n.length)throw new Error("Message is too big, increase bufferSize when making channel.");n.set(r,0),Atomics.store(c,0,r.length),Atomics.store(c,1,1),Atomics.notify(c,1)}function E(e,t,r){return w(this,void 0,void 0,function*(){yield navigator.serviceWorker.ready;const n=e.baseUrl+"/write",c=Date.now();for(;;){const o={message:t,messageId:r},i=yield fetch(n,{method:"POST",body:JSON.stringify(o)});if(i.status===200&&(yield i.json()).version===p)return;if(!(Date.now()-c<e.timeout))throw new y(n,i.status);yield b(100)}})}function P(e,t,r){return w(this,void 0,void 0,function*(){e.type==="atomics"?k(e,t):yield E(e,t,r)})}function M(e={}){return typeof SharedArrayBuffer<"u"?I(e.atomics):"serviceWorker"in navigator?O(e.serviceWorker):null}function I({bufferSize:e}={}){return{type:"atomics",data:new Uint8Array(new SharedArrayBuffer(e||131072)),meta:new Int32Array(new SharedArrayBuffer(2*Int32Array.BYTES_PER_ELEMENT))}}function O(e={}){return{type:"serviceWorker",baseUrl:(e.scope||"/")+S,timeout:e.timeout||5e3}}function v(e,t){return e>0?+e:t}function T(e,t,{checkInterrupt:r,checkTimeout:n,timeout:c}={}){const o=performance.now();n=v(n,r?100:5e3);const i=v(c,Number.POSITIVE_INFINITY);let u;if(e.type==="atomics"){const{data:a,meta:s}=e;u=()=>{if(Atomics.wait(s,1,0,n)==="timed-out")return null;{const f=Atomics.exchange(s,0,0),d=a.slice(0,f);Atomics.store(s,1,0);const h=new TextDecoder().decode(d);return JSON.parse(h)}}}else u=()=>{const a=new XMLHttpRequest,s=e.baseUrl+"/read";a.open("POST",s,!1);const f={messageId:t,timeout:n};a.send(JSON.stringify(f));const{status:d}=a;if(d===408)return null;if(d===200){const h=JSON.parse(a.responseText);return h.version!==p?null:h.message}if(performance.now()-o<e.timeout)return null;throw new y(s,d)};for(;;){const a=i-(performance.now()-o);if(a<=0)return null;n=Math.min(n,a);const s=u();if(s!==null)return s;if(r!=null&&r())return null}}function N(e,t){if(e=v(e,0))if(typeof SharedArrayBuffer<"u"){const r=new Int32Array(new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT));r[0]=0,Atomics.wait(r,0,0,e)}else T(t,`sleep ${e} ${g()}`,{timeout:e})}let g;return g="randomUUID"in crypto?function(){return crypto.randomUUID()}:function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>{const t=Number(e);return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)})},m})()})})(W);var U=W.exports;export{U as d};
